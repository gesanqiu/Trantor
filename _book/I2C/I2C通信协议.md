# I2C通信协议

## Introduction

`I2C(Inter-integrated circuit)`总线是由Philips公司开发的一种简单、双向二线制同步串行总线，目前被广泛应用在系统内多个`IC`间的通信。

I2C是一个能够支持多个设备的总线，包含一条双向串行数据线`SDA`，一条串行时钟线`SCL`。每个连接到总线的设备都有一个独立的地址，主机可以通过该地址来访问不同设备。**主机通过`SDA`线发送设备地址`（SLAVE_ADDRESS）`查找从机**，`SLAVE_ADDRESS`可以是7位或10位，紧跟着`SLAVE_ADDRESS`的一个数据位用来表示数据传输方向，即第8位或11位。为0时表示写数据，为1时表示读数据。

### I2C总线物理拓扑结构

![img](1219450-1601291104376.png)

- `SCL(serial clock)`：时钟线，传输`CLK`信号，只能由主设备产生，通信时通信双方工作在同一时钟下。
- `SDA(serial data)`：数据线，`I2C`所有数据以字节为单位在`SDA`线上串行传输。
- 通过对`SCL`和`SDA`线高低电平时序进行通信。

### 主从设备

通信由主设备发起，由主设备主导，从设备只是按照I2C协议被动的接受主设备的通信，并及时响应，主从设备可以由通信双方决定，但通常在硬件设计时指定。

- I2C通信可以一对一（一个主设备对1个从设备），也可以一对多（一个主设备对多个从设备）。
- 主设备负责调度总线，决定某一时刻和哪个从设备通信。同一时刻，I2C的总线上只能传输一对设备的通信信息，所以同一时刻只能有一个从设备和主设备通信（一对多通信时实际由于通信速度快用户并不会察觉到时延）。

### 双向传输

![i2c双向传输](20190407223725310.png)

主设备通过一根SDA线既可以把数据发给从设备，也可以从SDA上读取数据，连接SDA线的引脚里面有两个引脚（发送引脚/接受引脚），使用开极(极电集开发出去作为输出)电路选择功能。

当某一个芯片不想影响SDA线时，那就不驱动这个三极管。
想输出高电平时（读）；都不驱动(高电平就由上拉电阻决定)。
想输出低电平（写），就驱动三极管。

## I2C通信

### 数据有效性

`SDA `线上的数据必须在时钟的高电平周期保持稳定，数据线的高或低电平状态只有在 `SCL `线的时钟信号是低电平时才能改变。

换言之，`SCL`为高电平时表示有效数据，`SDA`为高电平表示“1”，低电平表示“0”；`SCL`为低电平时表示无效数据，此时`SDA`会进行电平切换，为下次数据表示做准备，即`SCL`在`CLK`上升沿锁存数据，接下来一个时钟周期要传输的数据必须在`CLK`上升沿到来前提前准备好。

![img](v2-2ca40d7d5aef1dfe773f0ffb62eccbd4_720w.png)

### 起始条件S和停止条件P

- 起始条件S：当`SCL`高电平时，`SDA`由高电平向低电平转换。
- 停止条件P：当`SCL`高电平时，`SDA`由低电平向高电平转换。

起始和停止条件一般由主机产生。总线在起始条件后处于忙碌的状态，由本次数据传输的主从设备独占，在停止条件的某段时间后，主设备释放总线才再次处于空闲状态。

![img](1219451.png)

### 数据传输格式

传输的每个字节必须为8位，而总字节数不受限制。每个字节后必须跟一个`ACK`响应位。首先开始传输的是数据最高位，即MSB位。如果此时从机正忙于其他功能，如正在中断服务程序，则需要使SCL线保持低电平迫使主机进入等待状态，直到从机准备完成。

![img](1219452.png)

### 响应ACK

**数据接收方**收到传输的一个字节数据后，需要给出响应，此时处在第九个时钟，发送端释放SDA线控制权，将SDA电平拉高，由接收方控制。若希望继续，则给出“应答（ACK）”信号，即SDA为低电平；反之给出“非应答（NACK）”信号，即SDA为高电平。

![img](v2-1b94eb9c96d3a4bfa02ae36b29c537f4_720w-1601293408397.png)

### 设备地址

I2C总线上的每一个设备都对应一个唯一的地址，主从设备之间的数据传输是建立在地址的基础上，也就是说，主设备在传输有效数据之前 要先指定从设备的地址，地址指定的过程和上面数据传输的过程一样，只不过大多数从设备的地址是7位的，然后协议规定再给地址添加一个最低位用来表示接下来 数据传输的方向，0表示主设备向从设备写数据，1表示主设备向从设备读数据。

![img](1219453.png)

## I2C读写操作

![img](20131110144134734.jpg)



关于读数据

- 读数据时第一次通信写入寄存器内部单元地址，这时从设备将根据寄存器地址将数据取出放入从设备的I2C输出buffer中，第二次通信将读寄存器中的数据读出并返回给主设备。

- 读单个字节数据不需要等待应答，写入寄存器地址后需要再次开启一个新的I2C通信。

## linux/i2c.h









## 参考

[I2C协议（上）——基础介绍](https://zhuanlan.zhihu.com/p/26579936)

[I2C总线协议详解](https://blog.csdn.net/w89436838/article/details/38660631?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.channel_param)

[\[Linux\]I2C设备读写及文件节点创建](https://www.cnblogs.com/all-for-fiona/p/3949654.html)](https://www.cnblogs.com/all-for-fiona/p/3949654.html)

